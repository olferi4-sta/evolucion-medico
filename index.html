<script>
let resultadoConforme = false;

function imcCalc(){
 if(peso.value && talla.value){
   imc.value=(peso.value/Math.pow(talla.value/100,2)).toFixed(1);
 }
}

function validarFormulario(){
 let err=[];
 if(!estudiante.value) err.push("Debe identificarse el estudiante");
 if(!tipoDoc.value||!numDoc.value||!nombre.value) err.push("Identificación incompleta");
 if(subjetivo.value.length<30) err.push("Subjetivo insuficiente");
 if(!peso.value||!talla.value||!tas.value||!tad.value||!fc.value) err.push("Signos vitales incompletos");
 if(objetivo.value.length<30) err.push("Objetivo insuficiente");
 if(analisis.value.length<50) err.push("Análisis insuficiente");
 if(!document.querySelector(".dxCheck:checked")&&!dxLibre.value) err.push("Diagnóstico obligatorio");
 if(medicamentos.value.length<30) err.push("Indicaciones médicas incompletas");
 if(!medico.value||!firma.value) err.push("Debe diligenciar firma del médico interno");

 errores.innerHTML=err.join("<br>");
 resultadoConforme = err.length===0;
 ok.innerHTML=resultadoConforme?"EVOLUCIÓN CONFORME":"";
 return resultadoConforme;
}

form.addEventListener("submit",e=>{
 e.preventDefault();
 validarFormulario();
});

function enviarSheets(){
 if(!validarFormulario()){
   alert("⚠ Revise los campos obligatorios");
   return;
 }

 const dxSeleccionados=[...document.querySelectorAll(".dxCheck:checked")]
 .map(d=>d.value).join(" | ") || dxLibre.value;

 fetch("https://script.google.com/macros/s/AKfycbwVb-7BkbkbrY_IcDnwiCXEO64lEJRys2BsawZsUy2_mGlFtD661sSkRQMeEfFGbkT0/exec",{
 method:"POST",
 headers:{"Content-Type":"application/json"},
 body:JSON.stringify({
  estudiante:estudiante.value,
  tipoDoc:tipoDoc.value,
  numDoc:numDoc.value,
  nombre:nombre.value,
  edad:edad.value,
  sexo:sexo.value,
  orientacion:orientacion.value,
  etnia:etnia.value,
  discapacidad:discapacidad.value,
  direccion:direccion.value,
  barrio:barrio.value,
  ciudad:ciudad.value,
  pais:pais.value,
  eps:eps.value,
  servicio:servicio.value,
  peso:peso.value,
  talla:talla.value,
  imc:imc.value,
  tas:tas.value,
  tad:tad.value,
  fc:fc.value,
  glasgow:glasgow.value,
  subjetivo:subjetivo.value,
  objetivo:objetivo.value,
  analisis:analisis.value,
  dx:dxSeleccionados,
  medicamentos:medicamentos.value,
  paraclinicos:paraclinicos.value,
  cuidados:cuidados.value,
  dieta:dieta.value,
  medico:medico.value,
  firma:firma.value,
  conforme:"SI"
 })
 }).then(res=>res.text())
 .then(()=>alert("✔ Evolución almacenada correctamente en Google Sheets"))
 .catch(()=>alert("❌ Error al enviar. Revise conexión o Apps Script"));
}

function descargarCSV(){
 const csv=[
 ["Estudiante","Paciente","DX","IMC","Médico","Firma","Conforme"],
 [estudiante.value,nombre.value,dxLibre.value,imc.value,medico.value,firma.value,"SI"]
 ].map(r=>r.join(",")).join("\n");

 const a=document.createElement("a");
 a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
 a.download="evolucion_clinica.csv";
 a.click();
}
</script>
