<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Evolución Clínica – Médico Interno HUEM</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root{--azul:#1e88e5;--gris:#f4f6f8}
body{font-family:Segoe UI,Arial;background:var(--gris);padding:20px}
.container{max-width:1200px;margin:auto;background:#fff;padding:25px;border-radius:8px}
.header{border-bottom:4px solid var(--azul);margin-bottom:20px}
.section{margin-top:25px}
.section h2{background:var(--azul);color:#fff;padding:8px;border-radius:6px;font-size:15px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
input,select,textarea{width:100%;padding:8px;border:1px solid #ccc;border-radius:5px}
textarea{resize:vertical}
.actions{display:flex;gap:10px;margin-top:20px;flex-wrap:wrap}
button{background:var(--azul);color:#fff;border:none;padding:10px 18px;border-radius:6px;cursor:pointer}
button.secondary{background:#6c757d}
.error{color:#b00020;margin-top:10px}
.ok{color:#1b5e20;font-weight:bold;margin-top:10px}
@media print{button,.actions,#btnMovil{display:none}}
@media (max-width:768px){
    body{padding:10px}
    .container{padding:15px}
    .section h2{text-align:center;font-size:14px}
    input,select,textarea{font-size:16px}
    .actions{flex-direction:column}
    button{width:100%}
}
</style>
</head>
<body>
<div class="container">
<div class="header">
<h1>Evolución Clínica – Médico Interno</h1>
<small>Hospital Universitario Erasmo Meoz · Simulación académica</small>
</div>

<!-- ACCESO -->
<div class="section">
<h2>Acceso del estudiante</h2>
<div class="grid">
<select id="tipoDoc">
    <option value="">Tipo documento</option>
    <option>RC</option><option>TI</option><option>CC</option><option>CE</option><option>PS</option>
</select>
<input id="numDoc" placeholder="Número de documento">
<input id="estudiante" placeholder="Nombre completo del médico interno">
</div>
</div>

<form id="form">

<!-- IDENTIFICACIÓN -->
<div class="section">
<h2>1. Identificación del paciente</h2>
<div class="grid">
<select id="tipoDocPaciente"><option value="">Tipo documento</option><option>RC</option><option>TI</option><option>CC</option><option>CE</option><option>PS</option></select>
<input id="numDocPaciente" placeholder="Documento">
<input id="nombre" placeholder="Nombre completo">
<input type="number" id="edad" placeholder="Edad">
<select id="sexo"><option value="">Sexo</option><option>Masculino</option><option>Femenino</option><option>Intersexual</option></select>
<select id="orientacion"><option value="">Orientación sexual</option><option>Heterosexual</option><option>Homosexual</option><option>Bisexual</option><option>Otro</option></select>
<select id="etnia"><option value="">Etnia</option><option>Mestizo</option><option>Afrodescendiente</option><option>Indígena</option><option>ROM</option><option>No aplica</option></select>
<select id="discapacidad"><option value="">Discapacidad</option><option>No</option><option>Física</option><option>Sensorial</option><option>Cognitiva</option></select>
<input id="direccion" placeholder="Dirección">
<input id="barrio" placeholder="Barrio">
<select id="ciudad"><option value="">Ciudad</option><option>Cúcuta</option><option>Los Patios</option><option>Villa del Rosario</option><option>Otra</option></select>
<select id="pais"><option value="">País</option><option>Colombia</option><option>Venezuela</option><option>Otro</option></select>
<select id="eps"><option value="">EPS</option><option>Nueva EPS</option><option>SURA</option><option>Sanitas</option><option>Coosalud</option><option>Salud Total</option><option>Otra</option></select>
<input id="servicio" placeholder="Servicio clínico">
</div>
</div>

<!-- SUBJETIVO -->
<div class="section">
<h2>2. Subjetivo</h2>
<textarea id="subjetivo" placeholder="Motivo de consulta (mínimo 30 caracteres)"></textarea>
</div>

<!-- SIGNOS -->
<div class="section">
<h2>3. Signos vitales</h2>
<div class="grid">
<input type="number" id="peso" placeholder="Peso (kg)" oninput="imcCalc()">
<input type="number" id="talla" placeholder="Talla (cm)" oninput="imcCalc()">
<input id="imc" placeholder="IMC" readonly>
<input type="number" id="tas" placeholder="TA Sistólica">
<input type="number" id="tad" placeholder="TA Diastólica">
<input type="number" id="fc" placeholder="Frecuencia cardiaca">
<input type="number" id="temperatura" placeholder="Temperatura °C" step="0.1">
<input type="number" id="glasgow" placeholder="Glasgow (3–15)">
</div>
</div>

<!-- OBJETIVO -->
<div class="section">
<h2>4. Evolución objetiva y análisis</h2>
<textarea id="objetivo" placeholder="Examen físico (mínimo 30 caracteres)"></textarea>
<textarea id="analisis" placeholder="Análisis clínico (mínimo 50 caracteres)"></textarea>
</div>

<!-- DIAGNÓSTICO -->
<div class="section">
<h2>5. Diagnóstico CIE-10 – Infarto Agudo del Miocardio</h2>
<select id="cie10Principal">
<option value="">Seleccione diagnóstico</option>
<option value="I21">I21 – Infarto agudo del miocardio</option>
<option value="I21.0">IAM pared anterior</option>
<option value="I21.1">IAM pared inferior</option>
<option value="I21.2">IAM otras localizaciones</option>
<option value="I22">Infarto recurrente</option>
</select>
<input id="cie10Relacionado" placeholder="Diagnóstico relacionado (opcional)">
</div>

<!-- 6. INDICACIONES MÉDICAS -->
<div class="section">
<h2>6. Indicaciones médicas</h2>
<textarea id="medicamentos" placeholder="Medicamentos (mínimo 30 caracteres)"></textarea>
<textarea id="paraclinicos" placeholder="Paraclínicos"></textarea>
<textarea id="cuidados" placeholder="Cuidados generales"></textarea>
<select id="dieta">
<option value="">Dieta</option>
<option>Libre</option>
<option>Blanda</option>
<option>Hiposódica</option>
<option>Diabética</option>
</select>
</div>

<!-- AUDITORÍA -->
<div class="section">
<h2>7. Auditoría clínica automática</h2>
<p><strong>Estado:</strong> <span id="estadoAuditoria">PENDIENTE</span></p>
<textarea id="obsAuditoria" readonly></textarea>
</div>

<div id="errores" class="error"></div>
<div id="ok" class="ok"></div>

<div class="actions">
<button type="submit">Validar evolución</button>
<button type="button" class="secondary" onclick="window.print()">PDF</button>
<button type="button" class="secondary" onclick="descargarCSV()">CSV</button>
<button type="button" class="secondary" onclick="enviarSheets()">Enviar evolución</button>
</div>
</form>
</div>

<button id="btnMovil" style="position:fixed;bottom:15px;right:15px;background:#1e88e5;color:#fff; padding:14px;border-radius:50%;border:none;font-size:18px;z-index:999" onclick="document.getElementById('form').requestSubmit()">✔</button>

<script>
let resultadoConforme=false;
let evoluciones = JSON.parse(localStorage.getItem("evoluciones") || "[]");

function imcCalc(){
    if(peso.value && talla.value){
        imc.value=(peso.value/Math.pow(talla.value/100,2)).toFixed(1);
    }
}

form.addEventListener("submit", e=>{
    e.preventDefault();
    let err=[];

    // VALIDACIÓN ESTUDIANTE
    if(!estudiante.value) err.push("Nombre del estudiante obligatorio");
    if(!tipoDoc.value) err.push("Tipo de documento obligatorio");
    if(!numDoc.value) err.push("Número de documento obligatorio");
    if(tipoDoc.value==="CC" && !/^\d{6,}$/.test(numDoc.value)) err.push("Número de cédula inválido");

    // EVOLUCIÓN
    if(subjetivo.value.length<30) err.push("Subjetivo insuficiente");
    if(analisis.value.length<50) err.push("Análisis insuficiente");
    if(!cie10Principal.value) err.push("Diagnóstico IAM obligatorio");

    // EVITAR DUPLICADOS
    const docCompleto = tipoDoc.value + "-" + numDoc.value;
    if(evoluciones.includes(docCompleto)){
        err.push("Ya existe una evolución registrada para este documento");
    }

    errores.innerHTML = err.join("<br>");
    resultadoConforme = err.length===0;
    ok.innerHTML = resultadoConforme?"EVOLUCIÓN CONFORME":"";

    if(resultadoConforme){
        evoluciones.push(docCompleto);
        localStorage.setItem("evoluciones", JSON.stringify(evoluciones));
    }

    auditoriaAutomatica();
});

function auditoriaAutomatica(){
    let obs=[];
    let aprobado=true;

    if(subjetivo.value.length<30){obs.push("Subjetivo incompleto");aprobado=false}
    if(analisis.value.length<50){obs.push("Análisis insuficiente");aprobado=false}
    if(!cie10Principal.value){obs.push("CIE-10 no registrado");aprobado=false}
    if(glasgow.value && glasgow.value<=8){obs.push("Paciente crítico");aprobado=false}
    if(!estudiante.value || !tipoDoc.value || !numDoc.value){obs.push("Documento del estudiante incompleto");aprobado=false}

    estadoAuditoria.textContent=aprobado?"APROBADO":"NO APROBADO";
    estadoAuditoria.style.color=aprobado?"green":"red";
    obsAuditoria.value=obs.length?obs.join(" | "):"Cumple criterios clínicos";
}

function enviarSheets(){
    if(!resultadoConforme){alert("Primero valide la evolución");return;}

    const data = {
        estudiante: estudiante.value,
        tipoDoc: tipoDoc.value,
        numDoc: numDoc.value,
        nombre: nombre.value,
        tipoDocPaciente: tipoDocPaciente.value,
        numDocPaciente: numDocPaciente.value,
        edad: edad.value,
        sexo: sexo.value,
        orientacion: orientacion.value,
        etnia: etnia.value,
        discapacidad: discapacidad.value,
        direccion: direccion.value,
        barrio: barrio.value,
        ciudad: ciudad.value,
        pais: pais.value,
        eps: eps.value,
        servicio: servicio.value,
        subjetivo: subjetivo.value,
        objetivo: objetivo.value,
        analisis: analisis.value,
        cie10Principal: cie10Principal.value,
        cie10Relacionado: cie10Relacionado.value,
        peso: peso.value,
        talla: talla.value,
        imc: imc.value,
        tas: tas.value,
        tad: tad.value,
        fc: fc.value,
        temperatura: temperatura.value,
        glasgow: glasgow.value,
        medicamentos: medicamentos.value,
        paraclinicos: paraclinicos.value,
        cuidados: cuidados.value,
        dieta: dieta.value
    };

    fetch("TU_URL_DE_WEB_APP_AQUI", {
        method: "POST",
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(res => {
        if(res.status==="ok"){
            alert("✔ Evolución enviada a Google Sheets correctamente");
        } else {
            alert("Error al enviar: "+res.message);
        }
    })
    .catch(err => alert("Error de conexión: "+err));
}

function descargarCSV(){
    const csv=`Estudiante,Documento,Paciente,DX,IMC,Temperatura
${estudiante.value},${tipoDoc.value}-${numDoc.value},${nombre.value},${cie10Principal.value},${imc.value},${temperatura.value}`;
    const a=document.createElement("a");
    a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
    a.download="evolucion_clinica.csv";
    a.click();
}
</script>
</body>
</html>
